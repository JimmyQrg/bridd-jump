<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Schedule | Infinite Campus</title>
<style>
  body { margin:0; background:#111; color:#0ff; font-family:Arial, sans-serif; overflow:hidden; }
  canvas { display:block; margin:0 auto; background:#222; }
  #startBtn { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
              padding:20px 40px; border:2px solid #0ff; background:black; color:#0ff;
              cursor:pointer; border-radius:10px; }
  #console { position:absolute; bottom:10px; left:50%; transform:translateX(-50%);
             width:400px; padding:5px; background:#000; border:2px solid #0ff; color:#0ff; }
  #uiBox { position:absolute; top:10px; right:10px; padding:10px;
           background:rgba(0,0,0,0.7); border:2px solid #0ff; border-radius:10px; }
</style>
</head>
<body>
<button id="startBtn">Start</button>
<canvas id="gameCanvas" width="800" height="600"></canvas>
<input id="console" placeholder="Enter command (e.g. /score add 10)" />
<div id="uiBox">
  <div id="scoreDisplay">Score: 0</div>
  <div id="bestDisplay">Best: 0</div>
  <div id="lastDisplay">Last Point: 0</div>
</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
let running = false;
let lastFrameTime = 0;

// ===== SETTINGS =====
let fps = localStorage.getItem("fps") || "60";
fps = (fps === "Unlimited") ? 0 : parseInt(fps);

let quality = localStorage.getItem("quality") || "Extreme+";
let adv = JSON.parse(localStorage.getItem("advancedSettings") || "{}");
adv = Object.assign({jump:20,walk:20,die:40,line:20,glow:20,trail:20,blockTexture:true}, adv);

// ===== GAME STATE =====
let score = 0;
let bestScore = parseInt(localStorage.getItem("bestScore") || "0");
let lastScore = parseInt(localStorage.getItem("lastScore") || "0");
let player = { x: 150, y: 500, vy:0, onGround:false, trail:[] };
let platforms = [];
let dieParticles = [];
let scanOffset = 0;

// UI updates
function updateUI(){
  document.getElementById("scoreDisplay").textContent = "Score: " + score;
  document.getElementById("bestDisplay").textContent = "Best: " + bestScore;
  document.getElementById("lastDisplay").textContent = "Last Point: " + lastScore;
}
updateUI();

// ===== PLATFORM GENERATOR =====
function spawnPlatform(){
  let x = canvas.width;
  let y = 450 + (Math.random()*100 - 50);
  let w = 100 + Math.random()*100;
  platforms.push({x, y, w, h:20});
}
function initPlatforms(){
  platforms = [];
  for(let i=0;i<6;i++){
    platforms.push({x:i*150, y:500, w:120, h:20});
  }
}

// ===== PARTICLE HELPERS =====
function makeParticles(x,y,count,color,size){
  for(let i=0;i<count;i++){
    dieParticles.push({
      x, y,
      vx:(Math.random()*2-1)*2,
      vy:(Math.random()*2-1)*2,
      life:50,
      color, size
    });
  }
}

// ===== GAME LOOP =====
function loop(timestamp){
  if(!running) return;

  if(fps>0){
    const interval = 1000/fps;
    if(timestamp - lastFrameTime < interval){
      requestAnimationFrame(loop);
      return;
    }
    lastFrameTime = timestamp;
  }

  ctx.fillStyle = "#111";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // Move & draw platforms
  ctx.fillStyle = "#0ff";
  platforms.forEach(p=>{
    ctx.fillRect(p.x, p.y, p.w, p.h);
    p.x -= 3;
  });
  // Remove old platforms
  platforms = platforms.filter(p=>p.x+p.w>0);
  // Ensure new platforms spawn
  if(platforms.length<6 || platforms[platforms.length-1].x<canvas.width-200){
    spawnPlatform();
  }

  // Apply gravity
  player.vy += 0.5;
  player.y += player.vy;
  player.onGround = false;

  // Check collisions
  for(let p of platforms){
    if(player.x>p.x && player.x<p.x+p.w &&
       player.y+20>=p.y && player.y+20<=p.y+p.h+10 && player.vy>=0){
      player.y = p.y-20;
      player.vy = 0;
      player.onGround = true;
    }
  }

  // Draw player
  ctx.fillStyle="#0ff";
  ctx.fillRect(player.x-10, player.y-20, 20, 20);

  // Score
  score++;
  if(score > bestScore){
    bestScore = score;
    localStorage.setItem("bestScore", bestScore);
  }
  updateUI();

  requestAnimationFrame(loop);
}

// ===== COMMAND HANDLER =====
document.getElementById("console").addEventListener("keydown", e=>{
  if(e.key==="Enter"){
    const cmd = e.target.value.trim();
    e.target.value = "";
    if(cmd.startsWith("/score")){
      const parts = cmd.split(" ");
      if(parts[1]==="set" && !isNaN(parts[2])) score = parseInt(parts[2]);
      if(parts[1]==="add" && !isNaN(parts[2])) score += parseInt(parts[2]);
    }
    if(cmd==="/clear bestScore"){
      bestScore = 0;
      localStorage.setItem("bestScore", 0);
    }
    if(cmd==="/die"){
      running = false;
      makeParticles(player.x,player.y,adv.die,"#0ff",5);
      lastScore = score;
      localStorage.setItem("lastScore", lastScore);
      alert("You died! Final score: "+score);
      updateUI();
      document.getElementById("startBtn").style.display="block";
    }
  }
});

// ===== CONTROLS =====
document.addEventListener("keydown", e=>{
  if(e.code==="Space" && player.onGround){
    player.vy = -10; // jump
  }
});

// ===== START =====
document.getElementById("startBtn").addEventListener("click", ()=>{
  running = true;
  score = 0;
  initPlatforms();
  player.x = 150;
  player.y = 500;
  player.vy = 0;
  document.getElementById("startBtn").style.display="none";
  requestAnimationFrame(loop);
});
</script>
</body>
</html>
